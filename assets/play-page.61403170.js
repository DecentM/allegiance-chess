var P=Object.defineProperty;var B=(p,l,r)=>l in p?P(p,l,{enumerable:!0,configurable:!0,writable:!0,value:r}):p[l]=r;var y=(p,l,r)=>(B(p,typeof l!="symbol"?l+"":l,r),r);import{u as R}from"./use-can-render.4545edad.js";import{c as D,e as A,h as S,aj as T,r as x,B as F,o as I,d as k,a as b,M as j,ak as H,al as Q,w as L,Y as V,N as q,O as J,P as U,S as $,$ as z}from"./index.a90b662f.js";import{H as M}from"./hex.4b156ad2.js";import{u as W}from"./use-quasar.46dd5b37.js";import{F as Y}from"./boards.07b20eb6.js";var G=D({name:"QNoSsr",props:{tag:{type:String,default:"div"},placeholder:String},setup(p,{slots:l}){const r=R();return()=>{const m={};if(r.value===!0){const a=A(l.default);return a===void 0?a:a.length>1?S(p.tag,m,a):a[0]}m.class="q-no-ssr-placeholder";const d=A(l.placeholder);if(d!==void 0)return d.length>1?S(p.tag,m,d):d[0];if(p.placeholder!==void 0)return S(p.tag,m,p.placeholder)}}});const K=()=>{const p=W();return{notify:r=>{p.notify({timeout:4e3,position:"bottom-right",...r})}}};var N={exports:{}};(function(p){var l=Object.prototype.hasOwnProperty,r="~";function m(){}Object.create&&(m.prototype=Object.create(null),new m().__proto__||(r=!1));function d(c,o,s){this.fn=c,this.context=o,this.once=s||!1}function a(c,o,s,e,t){if(typeof s!="function")throw new TypeError("The listener must be a function");var v=new d(s,e||c,t),i=r?r+o:o;return c._events[i]?c._events[i].fn?c._events[i]=[c._events[i],v]:c._events[i].push(v):(c._events[i]=v,c._eventsCount++),c}function _(c,o){--c._eventsCount===0?c._events=new m:delete c._events[o]}function u(){this._events=new m,this._eventsCount=0}u.prototype.eventNames=function(){var o=[],s,e;if(this._eventsCount===0)return o;for(e in s=this._events)l.call(s,e)&&o.push(r?e.slice(1):e);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(s)):o},u.prototype.listeners=function(o){var s=r?r+o:o,e=this._events[s];if(!e)return[];if(e.fn)return[e.fn];for(var t=0,v=e.length,i=new Array(v);t<v;t++)i[t]=e[t].fn;return i},u.prototype.listenerCount=function(o){var s=r?r+o:o,e=this._events[s];return e?e.fn?1:e.length:0},u.prototype.emit=function(o,s,e,t,v,i){var g=r?r+o:o;if(!this._events[g])return!1;var n=this._events[g],C=arguments.length,h,f;if(n.fn){switch(n.once&&this.removeListener(o,n.fn,void 0,!0),C){case 1:return n.fn.call(n.context),!0;case 2:return n.fn.call(n.context,s),!0;case 3:return n.fn.call(n.context,s,e),!0;case 4:return n.fn.call(n.context,s,e,t),!0;case 5:return n.fn.call(n.context,s,e,t,v),!0;case 6:return n.fn.call(n.context,s,e,t,v,i),!0}for(f=1,h=new Array(C-1);f<C;f++)h[f-1]=arguments[f];n.fn.apply(n.context,h)}else{var E=n.length,w;for(f=0;f<E;f++)switch(n[f].once&&this.removeListener(o,n[f].fn,void 0,!0),C){case 1:n[f].fn.call(n[f].context);break;case 2:n[f].fn.call(n[f].context,s);break;case 3:n[f].fn.call(n[f].context,s,e);break;case 4:n[f].fn.call(n[f].context,s,e,t);break;default:if(!h)for(w=1,h=new Array(C-1);w<C;w++)h[w-1]=arguments[w];n[f].fn.apply(n[f].context,h)}}return!0},u.prototype.on=function(o,s,e){return a(this,o,s,e,!1)},u.prototype.once=function(o,s,e){return a(this,o,s,e,!0)},u.prototype.removeListener=function(o,s,e,t){var v=r?r+o:o;if(!this._events[v])return this;if(!s)return _(this,v),this;var i=this._events[v];if(i.fn)i.fn===s&&(!t||i.once)&&(!e||i.context===e)&&_(this,v);else{for(var g=0,n=[],C=i.length;g<C;g++)(i[g].fn!==s||t&&!i[g].once||e&&i[g].context!==e)&&n.push(i[g]);n.length?this._events[v]=n.length===1?n[0]:n:_(this,v)}return this},u.prototype.removeAllListeners=function(o){var s;return o?(s=r?r+o:o,this._events[s]&&_(this,s)):(this._events=new m,this._eventsCount=0),this},u.prototype.off=u.prototype.removeListener,u.prototype.addListener=u.prototype.on,u.prefixed=r,u.EventEmitter=u,p.exports=u})(N);class X extends N.exports.EventEmitter{constructor(){super(...arguments);y(this,"id","mock-peer");y(this,"options",{});y(this,"open",!1);y(this,"socket",null);y(this,"connections",{});y(this,"destroyed",!1);y(this,"disconnected",!1);y(this,"_getMessages",()=>[]);y(this,"connect",()=>null);y(this,"call",()=>null);y(this,"_removeConnection",()=>null);y(this,"getConnection",()=>null);y(this,"destroy",()=>null);y(this,"disconnect",()=>null);y(this,"reconnect",()=>null);y(this,"listAllPeers",()=>null);y(this,"emitError",()=>null);y(this,"_serializers",{})}}const Z=async()=>{if(typeof window=="undefined")return X;const{Peer:p}=await T(()=>import("./bundler.c73083e1.js"),["assets/bundler.c73083e1.js","assets/index.a90b662f.js","assets/index.d684e578.css"]);return p},ee=async()=>{const p=await Z(),l=x(null),{notify:r}=K(),m=x(null),d=x([]),a=x(),_=x("initial"),u=t=>{d.value=[...d.value,t]},c=t=>{const v=h=>{if(h instanceof ArrayBuffer){u({type:"data",value:k.Buffer.from(h)});return}if(!k.Buffer.isBuffer(h)){console.warn("Non-buffer data received through WebRTC!",h);return}u({type:"data",value:h})},i=h=>{u({type:"state",value:h})},g=()=>{u({type:"open",value:void 0})},n=h=>{var f;u({type:"error",value:h}),(f=a.value)==null||f.close(),r({message:"Connection error",caption:h.message,icon:"link_off",iconColor:"red"})},C=()=>{var h,f,E,w,O;(h=a.value)==null||h.on("data",v),(f=a.value)==null||f.on("error",n),(E=a.value)==null||E.on("close",C),(w=a.value)==null||w.on("iceStateChanged",i),(O=a.value)==null||O.on("open",g),_.value="initial",a.value=null,d.value=[],r({message:"Connection closed",icon:"link_off"})};t.on("data",v),t.on("error",n),t.on("close",C),t.on("iceStateChanged",i),t.on("open",g)};return F(()=>{l.value=new p,l.value.on("open",t=>{m.value=M.utf8ToHex(t),r({message:"Connection ready",icon:"check",iconColor:"green"})}),l.value.on("connection",t=>{if(a.value){r({message:"Refused secondary connection",icon:"link_off",iconColor:"red"}),t.close();return}_.value="server",c(t),a.value=t,r({message:"Connected to guest",icon:"link"})})}),I(()=>{var t,v;(t=l.value)==null||t.destroy(),(v=a.value)==null||v.close()}),{connect:t=>{if(a.value||!l.value||!t)return;const v=M.hexToUtf8(t),i=l.value.connect(v);_.value="client",c(i),a.value=i,r({message:"Connected to host",icon:"link"})},mode:_,peerId:m,messages:d,sendData:t=>a.value?(a.value.send(t),u({type:"data",value:t}),!0):!1,disconnect:()=>a.value?(a.value.close(),a.value=null,!0):!1}},te=async()=>{const{connect:p,mode:l,peerId:r,sendData:m,messages:d,disconnect:a}=await ee(),_=e=>{m(k.Buffer.from(JSON.stringify(e),"utf8"))},u=b(()=>d.value.filter(e=>e.type==="data").map(e=>k.Buffer.isBuffer(e.value)?JSON.parse(e.value.toString("utf8")):null)),c=b(()=>{const e=u.value.findLast(t=>t.type==="afen-update");return e&&e.value||""}),o=b(()=>d.value.some(e=>e.type==="open")),s=b(()=>{const e=u.value.find(t=>t.type==="side-assignment");return e?e.value:null});return{connect:p,mode:l,peerId:r,boardAFEN:c,sendMessage:_,open:o,disconnect:a,serverSide:s}},ue=j({__name:"play-page",async setup(p){let l,r;const m=H(),d=([l,r]=Q(()=>te()),l=await l,r(),l);return L(d.mode,a=>{a==="initial"&&m.push("/play")}),L(d.open,a=>{!a||(m.push(`/play/online/${d.peerId.value}`),d.mode.value==="server"&&(d.sendMessage({type:"side-assignment",value:Math.random()>.5?"white":"black"}),d.sendMessage({type:"afen-update",value:Y.VanillaDefault})))}),(a,_)=>{const u=V("router-view");return q(),J(G,null,{default:U(()=>[$(u,{connection:z(d)},null,8,["connection"])]),_:1})}}});export{ue as default};
