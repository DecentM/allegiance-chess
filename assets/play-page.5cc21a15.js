var B=Object.defineProperty;var P=(h,f,r)=>f in h?B(h,f,{enumerable:!0,configurable:!0,writable:!0,value:r}):h[f]=r;var d=(h,f,r)=>(P(h,typeof f!="symbol"?f+"":f,r),r);import{aj as N,r as C,B as S,o as R,d as k,a as b,M as D,ak as T,al as F,w as A,Y as I,N as j,O as H,$ as J}from"./index.3c0fead1.js";import{H as L}from"./hex.b4824a29.js";import{u as U}from"./use-quasar.77f7fb29.js";import{F as V}from"./boards.07b20eb6.js";const $=()=>{const h=U();return{notify:r=>{h.notify({timeout:4e3,position:"bottom-right",...r})}}};var M={exports:{}};(function(h){var f=Object.prototype.hasOwnProperty,r="~";function _(){}Object.create&&(_.prototype=Object.create(null),new _().__proto__||(r=!1));function y(l,s,o){this.fn=l,this.context=s,this.once=o||!1}function u(l,s,o,e,n){if(typeof o!="function")throw new TypeError("The listener must be a function");var v=new y(o,e||l,n),i=r?r+s:s;return l._events[i]?l._events[i].fn?l._events[i]=[l._events[i],v]:l._events[i].push(v):(l._events[i]=v,l._eventsCount++),l}function m(l,s){--l._eventsCount===0?l._events=new _:delete l._events[s]}function a(){this._events=new _,this._eventsCount=0}a.prototype.eventNames=function(){var s=[],o,e;if(this._eventsCount===0)return s;for(e in o=this._events)f.call(o,e)&&s.push(r?e.slice(1):e);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(o)):s},a.prototype.listeners=function(s){var o=r?r+s:s,e=this._events[o];if(!e)return[];if(e.fn)return[e.fn];for(var n=0,v=e.length,i=new Array(v);n<v;n++)i[n]=e[n].fn;return i},a.prototype.listenerCount=function(s){var o=r?r+s:s,e=this._events[o];return e?e.fn?1:e.length:0},a.prototype.emit=function(s,o,e,n,v,i){var g=r?r+s:s;if(!this._events[g])return!1;var t=this._events[g],w=arguments.length,p,c;if(t.fn){switch(t.once&&this.removeListener(s,t.fn,void 0,!0),w){case 1:return t.fn.call(t.context),!0;case 2:return t.fn.call(t.context,o),!0;case 3:return t.fn.call(t.context,o,e),!0;case 4:return t.fn.call(t.context,o,e,n),!0;case 5:return t.fn.call(t.context,o,e,n,v),!0;case 6:return t.fn.call(t.context,o,e,n,v,i),!0}for(c=1,p=new Array(w-1);c<w;c++)p[c-1]=arguments[c];t.fn.apply(t.context,p)}else{var E=t.length,x;for(c=0;c<E;c++)switch(t[c].once&&this.removeListener(s,t[c].fn,void 0,!0),w){case 1:t[c].fn.call(t[c].context);break;case 2:t[c].fn.call(t[c].context,o);break;case 3:t[c].fn.call(t[c].context,o,e);break;case 4:t[c].fn.call(t[c].context,o,e,n);break;default:if(!p)for(x=1,p=new Array(w-1);x<w;x++)p[x-1]=arguments[x];t[c].fn.apply(t[c].context,p)}}return!0},a.prototype.on=function(s,o,e){return u(this,s,o,e,!1)},a.prototype.once=function(s,o,e){return u(this,s,o,e,!0)},a.prototype.removeListener=function(s,o,e,n){var v=r?r+s:s;if(!this._events[v])return this;if(!o)return m(this,v),this;var i=this._events[v];if(i.fn)i.fn===o&&(!n||i.once)&&(!e||i.context===e)&&m(this,v);else{for(var g=0,t=[],w=i.length;g<w;g++)(i[g].fn!==o||n&&!i[g].once||e&&i[g].context!==e)&&t.push(i[g]);t.length?this._events[v]=t.length===1?t[0]:t:m(this,v)}return this},a.prototype.removeAllListeners=function(s){var o;return s?(o=r?r+s:s,this._events[o]&&m(this,o)):(this._events=new _,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=r,a.EventEmitter=a,h.exports=a})(M);class q extends M.exports.EventEmitter{constructor(){super(...arguments);d(this,"id","mock-peer");d(this,"options",{});d(this,"open",!1);d(this,"socket",null);d(this,"connections",{});d(this,"destroyed",!1);d(this,"disconnected",!1);d(this,"_getMessages",()=>[]);d(this,"connect",()=>null);d(this,"call",()=>null);d(this,"_removeConnection",()=>null);d(this,"getConnection",()=>null);d(this,"destroy",()=>null);d(this,"disconnect",()=>null);d(this,"reconnect",()=>null);d(this,"listAllPeers",()=>null);d(this,"emitError",()=>null);d(this,"_serializers",{})}}const z=async()=>{if(typeof window=="undefined")return q;const{Peer:h}=await N(()=>import("./bundler.306d944f.js"),["assets/bundler.306d944f.js","assets/index.3c0fead1.js","assets/index.d684e578.css"]);return h},Q=async()=>{const h=await z(),f=C(null),{notify:r}=$(),_=C(null),y=C([]),u=C(),m=C("initial"),a=n=>{y.value=[...y.value,n]},l=n=>{const v=p=>{if(p instanceof ArrayBuffer){a({type:"data",value:k.Buffer.from(p)});return}if(!k.Buffer.isBuffer(p)){console.warn("Non-buffer data received through WebRTC!",p);return}a({type:"data",value:p})},i=p=>{a({type:"state",value:p})},g=()=>{a({type:"open",value:void 0})},t=p=>{var c;a({type:"error",value:p}),(c=u.value)==null||c.close(),r({message:"Connection error",caption:p.message,icon:"link_off",iconColor:"red"})},w=()=>{var p,c,E,x,O;(p=u.value)==null||p.on("data",v),(c=u.value)==null||c.on("error",t),(E=u.value)==null||E.on("close",w),(x=u.value)==null||x.on("iceStateChanged",i),(O=u.value)==null||O.on("open",g),m.value="initial",u.value=null,y.value=[],r({message:"Connection closed",icon:"link_off"})};n.on("data",v),n.on("error",t),n.on("close",w),n.on("iceStateChanged",i),n.on("open",g)};return S(()=>{f.value=new h,f.value.on("open",n=>{_.value=L.utf8ToHex(n),r({message:"Connection ready",icon:"check",iconColor:"green"})}),f.value.on("connection",n=>{if(u.value){r({message:"Refused secondary connection",icon:"link_off",iconColor:"red"}),n.close();return}m.value="server",l(n),u.value=n,r({message:"Connected to guest",icon:"link"})})}),R(()=>{var n,v;(n=f.value)==null||n.destroy(),(v=u.value)==null||v.close()}),{connect:n=>{if(u.value||!f.value||!n)return;const v=L.hexToUtf8(n),i=f.value.connect(v);m.value="client",l(i),u.value=i,r({message:"Connected to host",icon:"link"})},mode:m,peerId:_,messages:y,sendData:n=>u.value?(u.value.send(n),a({type:"data",value:n}),!0):!1,disconnect:()=>u.value?(u.value.close(),u.value=null,!0):!1}},W=async()=>{const{connect:h,mode:f,peerId:r,sendData:_,messages:y,disconnect:u}=await Q(),m=e=>{_(k.Buffer.from(JSON.stringify(e),"utf8"))},a=b(()=>y.value.filter(e=>e.type==="data").map(e=>k.Buffer.isBuffer(e.value)?JSON.parse(e.value.toString("utf8")):null)),l=b(()=>{const e=a.value.findLast(n=>n.type==="afen-update");return e&&e.value||""}),s=b(()=>y.value.some(e=>e.type==="open")),o=b(()=>{const e=a.value.find(n=>n.type==="side-assignment");return e?e.value:null});return{connect:h,mode:f,peerId:r,boardAFEN:l,sendMessage:m,open:s,disconnect:u,serverSide:o}},ee=D({__name:"play-page",async setup(h){let f,r;const _=T(),y=([f,r]=F(()=>W()),f=await f,r(),f);return A(y.mode,u=>{u==="initial"&&_.push("/play")}),A(y.open,u=>{!u||(_.push(`/play/online/${y.peerId.value}`),y.mode.value==="server"&&(y.sendMessage({type:"side-assignment",value:Math.random()>.5?"white":"black"}),y.sendMessage({type:"afen-update",value:V.VanillaDefault})))}),(u,m)=>{const a=I("router-view");return j(),H(a,{connection:J(y)},null,8,["connection"])}}});export{ee as default};
